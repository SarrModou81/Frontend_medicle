<!-- src/app/components/patient/paiement/paiement.component.html - VERSION CORRIG√âE -->
<div class="paiement-container" *ngIf="!isLoading">
  <div class="page-header">
    <button mat-icon-button (click)="retourner()" class="back-button">
      <mat-icon>arrow_back</mat-icon>
    </button>
    <h1>Paiement de la consultation</h1>
  </div>

  <!-- R√©capitulatif du rendez-vous -->
  <mat-card class="rdv-summary-card">
    <mat-card-header>
      <mat-card-title>R√©capitulatif de votre rendez-vous</mat-card-title>
    </mat-card-header>
    <mat-card-content>
      <div class="summary-row">
        <span class="label">M√©decin :</span>
        <span class="value">Dr. {{ rendezVous?.medecin?.user?.nom }} {{ rendezVous?.medecin?.user?.prenom }}</span>
      </div>
      <div class="summary-row">
        <span class="label">Sp√©cialit√© :</span>
        <span class="value">{{ rendezVous?.medecin?.specialite?.nom }}</span>
      </div>
      <div class="summary-row">
        <span class="label">Date :</span>
        <span class="value">{{ rendezVous?.date_heure | date:'EEEE d MMMM yyyy':'fr' }}</span>
      </div>
      <div class="summary-row">
        <span class="label">Heure :</span>
        <span class="value">{{ rendezVous?.date_heure | date:'HH:mm':'fr' }}</span>
      </div>
      <div class="summary-row total">
        <span class="label">Montant √† payer :</span>
        <span class="value price">{{ formatPrix(rendezVous?.montant || 0) }}</span>
      </div>
    </mat-card-content>
  </mat-card>

  <!-- Formulaire de paiement -->
  <mat-card class="payment-card">
    <mat-card-header>
      <mat-card-title>Informations de paiement</mat-card-title>
      <mat-card-subtitle>Paiement s√©curis√© par Stripe</mat-card-subtitle>
    </mat-card-header>
    
    <mat-card-content>
      <form [formGroup]="paiementForm" (ngSubmit)="onSubmit()">
        
        <!-- M√©thode de paiement -->
        <div class="payment-method-section">
          <h3>M√©thode de paiement</h3>
          <mat-radio-group formControlName="methode" class="payment-options">
            <mat-radio-button value="stripe" class="payment-option">
              <div class="payment-content">
                <div class="payment-header">
                  <mat-icon>credit_card</mat-icon>
                  <span>Carte bancaire</span>
                </div>
                <small>Paiement s√©curis√© par Stripe</small>
                <div class="card-icons">
                  <span class="card-icon">üí≥</span>
                  <span class="card-text">Visa, Mastercard</span>
                </div>
              </div>
            </mat-radio-button>
          </mat-radio-group>
        </div>

        <!-- Formulaire de carte -->
        <div class="card-section" *ngIf="paiementForm.get('methode')?.value === 'stripe'">
          <h3>Informations de carte</h3>
          
          <!-- Status de Stripe -->
          <div class="stripe-status" *ngIf="!stripeReady">
            <div class="stripe-loading">
              <mat-spinner diameter="20"></mat-spinner>
              <span>Initialisation du syst√®me de paiement...</span>
            </div>
          </div>
          
          <!-- Debug info (√† retirer en production) -->
          <div class="debug-info" *ngIf="false" style="background: #f0f0f0; padding: 10px; margin: 10px 0; font-size: 12px;">
            <strong>Debug Stripe:</strong><br>
            Service charg√©: {{ isStripeLoaded }}<br>
            Carte mont√©e: {{ isCardMounted }}<br>
            Pr√™t: {{ stripeReady }}
          </div>
          
          <div class="card-element-container" [class.disabled]="!stripeReady">
            <div id="card-element" class="card-element">
              <!-- Stripe Elements injectera le formulaire de carte ici -->
            </div>
            <div id="card-errors" class="card-errors" role="alert"></div>
            
            <!-- Message si Stripe n'est pas pr√™t -->
            <div *ngIf="!stripeReady" class="stripe-not-ready">
              <mat-icon>warning</mat-icon>
              <span>Chargement du syst√®me de paiement en cours...</span>
            </div>
          </div>
        </div>

        <!-- S√©curit√© -->
        <div class="security-section">
          <div class="security-info">
            <mat-icon>security</mat-icon>
            <div>
              <p><strong>Paiement 100% s√©curis√©</strong></p>
              <p>Vos donn√©es bancaires sont chiffr√©es et ne sont jamais stock√©es sur nos serveurs.</p>
            </div>
          </div>
        </div>

        <!-- Conditions -->
        <div class="conditions-section">
          <mat-checkbox formControlName="accepteConditions">
            J'accepte les <a href="#" target="_blank">conditions g√©n√©rales de vente</a> et 
            la <a href="#" target="_blank">politique de confidentialit√©</a>
          </mat-checkbox>
        </div>

      </form>
    </mat-card-content>

    <mat-card-actions class="payment-actions">
      <button mat-button (click)="retourner()" [disabled]="isProcessing">
        Annuler
      </button>
      <button mat-raised-button 
              color="primary" 
              (click)="onSubmit()"
              [disabled]="!isFormValid"
              class="pay-button">
        <mat-icon *ngIf="isProcessing" class="spinner">refresh</mat-icon>
        <span *ngIf="!stripeReady && !isProcessing">Initialisation...</span>
        <span *ngIf="stripeReady && !isProcessing">Payer {{ formatPrix(rendezVous?.montant || 0) }}</span>
        <span *ngIf="isProcessing">Traitement...</span>
      </button>
    </mat-card-actions>
  </mat-card>

  <!-- Informations compl√©mentaires -->
  <mat-card class="info-card">
    <mat-card-content>
      <h3>Informations importantes</h3>
      <ul>
        <li>Votre rendez-vous sera confirm√© apr√®s validation du paiement</li>
        <li>En cas d'annulation, le remboursement se fera dans un d√©lai de 3 √† 5 jours ouvr√©s</li>
        <li>Un justificatif PDF sera automatiquement g√©n√©r√© apr√®s votre consultation</li>
        <li>Vous recevrez une confirmation par email</li>
      </ul>
    </mat-card-content>
  </mat-card>
</div>

<!-- Chargement -->
<div *ngIf="isLoading" class="loading-container">
  <mat-spinner></mat-spinner>
  <p>Chargement...</p>
</div>