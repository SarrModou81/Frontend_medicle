<!-- src/app/components/patient/paiement/paiement.component.html - VERSION OPTIMIS√âE -->
<div class="paiement-container" *ngIf="!isLoading">
  <div class="page-header">
    <button mat-icon-button (click)="retourner()" class="back-button">
      <mat-icon>arrow_back</mat-icon>
    </button>
    <h1>Paiement de la consultation</h1>
  </div>

  <!-- R√©capitulatif du rendez-vous -->
  <mat-card class="rdv-summary-card">
    <mat-card-header>
      <mat-card-title>R√©capitulatif de votre rendez-vous</mat-card-title>
    </mat-card-header>
    <mat-card-content>
      <div class="summary-row">
        <span class="label">M√©decin :</span>
        <span class="value">Dr. {{ rendezVous?.medecin?.user?.nom }} {{ rendezVous?.medecin?.user?.prenom }}</span>
      </div>
      <div class="summary-row">
        <span class="label">Sp√©cialit√© :</span>
        <span class="value">{{ rendezVous?.medecin?.specialite?.nom }}</span>
      </div>
      <div class="summary-row">
        <span class="label">Date :</span>
        <span class="value">{{ rendezVous?.date_heure | date:'EEEE d MMMM yyyy':'fr' }}</span>
      </div>
      <div class="summary-row">
        <span class="label">Heure :</span>
        <span class="value">{{ rendezVous?.date_heure | date:'HH:mm':'fr' }}</span>
      </div>
      <div class="summary-row total">
        <span class="label">Montant √† payer :</span>
        <span class="value price">{{ formatPrix(rendezVous?.montant || 0) }}</span>
      </div>
    </mat-card-content>
  </mat-card>

  <!-- Formulaire de paiement -->
  <mat-card class="payment-card">
    <mat-card-header>
      <mat-card-title>Informations de paiement</mat-card-title>
      <mat-card-subtitle>Paiement s√©curis√© par Stripe</mat-card-subtitle>
    </mat-card-header>
    
    <mat-card-content>
      <form [formGroup]="paiementForm" (ngSubmit)="onSubmit()">
        
        <!-- M√©thode de paiement -->
        <div class="payment-method-section">
          <h3>M√©thode de paiement</h3>
          <mat-radio-group formControlName="methode" class="payment-options">
            <mat-radio-button value="stripe" class="payment-option">
              <div class="payment-content">
                <div class="payment-header">
                  <mat-icon>credit_card</mat-icon>
                  <span>Carte bancaire</span>
                </div>
                <small>Paiement s√©curis√© par Stripe</small>
                <div class="card-icons">
                  <span class="card-icon">üí≥</span>
                  <span class="card-text">Visa, Mastercard</span>
                </div>
              </div>
            </mat-radio-button>
          </mat-radio-group>
        </div>

        <!-- Formulaire de carte - VERSION OPTIMIS√âE -->
        <div class="card-section" *ngIf="paiementForm.get('methode')?.value === 'stripe'">
          <h3>Informations de carte</h3>
          
          <!-- Affichage optimis√© du statut -->
          <div class="stripe-status" *ngIf="!stripeReady">
            <div class="stripe-loading" *ngIf="!hasStripeError">
              <mat-spinner diameter="20"></mat-spinner>
              <span>Chargement du syst√®me de paiement...</span>
            </div>
            
            <!-- Erreur Stripe -->
            <div class="stripe-error" *ngIf="hasStripeError">
              <mat-icon>error</mat-icon>
              <span>{{ stripeError }}</span>
              <button mat-button color="primary" (click)="initializeStripe()">
                R√©essayer
              </button>
            </div>
          </div>
          
          <!-- √âl√©ment carte optimis√© -->
          <div class="card-element-container" [class.ready]="stripeReady" [class.disabled]="!stripeReady">
            <div id="card-element" class="card-element">
              <!-- Stripe Elements injectera le formulaire de carte ici -->
            </div>
            <div id="card-errors" class="card-errors" role="alert"></div>
          </div>

          <!-- Cartes de test (dev seulement) -->
          <div class="test-cards" *ngIf="!isProduction">
            <small>
              <strong>Cartes de test :</strong><br>
              Succ√®s : 4242 4242 4242 4242<br>
              √âchec : 4000 0000 0000 0002
            </small>
          </div>
        </div>

        <!-- Conditions -->
        <div class="conditions-section">
          <mat-checkbox formControlName="accepteConditions">
            J'accepte les <a href="#" target="_blank">conditions g√©n√©rales de vente</a> et 
            la <a href="#" target="_blank">politique de confidentialit√©</a>
          </mat-checkbox>
        </div>

      </form>
    </mat-card-content>

    <mat-card-actions class="payment-actions">
      <button mat-button (click)="retourner()" [disabled]="isProcessing">
        Annuler
      </button>
      <button mat-raised-button 
              color="primary" 
              (click)="onSubmit()"
              [disabled]="!isFormValid"
              class="pay-button">
        <mat-icon *ngIf="isProcessing" class="spinner">refresh</mat-icon>
        
        <!-- √âtats du bouton optimis√©s -->
        <span *ngIf="!stripeReady && !isProcessing && !hasStripeError">Chargement...</span>
        <span *ngIf="hasStripeError && !isProcessing">Syst√®me indisponible</span>
        <span *ngIf="stripeReady && !isProcessing">Payer {{ formatPrix(rendezVous?.montant || 0) }}</span>
        <span *ngIf="isProcessing">Traitement en cours...</span>
      </button>
    </mat-card-actions>
  </mat-card>

  <!-- S√©curit√© -->
  <mat-card class="security-card">
    <mat-card-content>
      <div class="security-info">
        <mat-icon>security</mat-icon>
        <div>
          <h4>Paiement 100% s√©curis√©</h4>
          <p>Vos donn√©es bancaires sont chiffr√©es et prot√©g√©es par Stripe, leader mondial de la s√©curit√© des paiements en ligne.</p>
          <ul>
            <li>Chiffrement SSL 256 bits</li>
            <li>Certification PCI DSS Level 1</li>
            <li>Aucune donn√©e bancaire stock√©e</li>
          </ul>
        </div>
      </div>
    </mat-card-content>
  </mat-card>
</div>

<!-- Chargement initial optimis√© -->
<div *ngIf="isLoading" class="loading-container">
  <div class="loading-content">
    <mat-spinner diameter="50"></mat-spinner>
    <h3>Pr√©paration du paiement</h3>
    <p>Chargement des informations...</p>
  </div>
</div>